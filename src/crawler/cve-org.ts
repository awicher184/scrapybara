import type { CveRecord, SummarizedRecord } from "./cve-org.types.ts";
const fetchCveRecords = async (): Promise<Array<CveRecord> | undefined >=> {
	const CVE_ORG_API_URL = 'https://www.cve.org/restapiv1/search'
	const QUERY_STRING = "next.js"
	const DEFAULT_PAGE_SIZE = 25

	const body = {
		query: QUERY_STRING,
		from: 0,
		size: DEFAULT_PAGE_SIZE,
		sort: {
			property:"cveId",
			order:"desc"
		}
	}

	const options = {
		method: 'POST',
		body: JSON.stringify(body)
	}

	try {
		const response = await fetch(CVE_ORG_API_URL, options)
		if (!response.ok) {
			throw new Error(`Failed to fetch records with status ${response.status} - ${response.statusText}`)
		}
		const jsonData = await response.json() as { data: Array<CveRecord> }
		return jsonData.data
	} catch (error) {
		throw new Error(`Error while fetching records: ${error}`)
	}
}

const extractRelevantRecordData = (records: Array<CveRecord> | undefined): Array<SummarizedRecord> => {
	if (!records) {
		return []
	}
	return records.map(
		record => {
			const metrics = record._source.containers.cna.metrics[0]
			return {
				cveId: record._source.cveMetadata.cveId,
				cvss: metrics.cvssV4_0?.baseScore || metrics.cvssV3_1?.baseScore,
				title: record._source.containers.cna.title,
				state: record._source.cveMetadata.state,
				publishDate: record._source.cveMetadata.datePublished,
			}
		}
	)
}


const scrape = async () => {
	const records = await fetchCveRecords()
	const summary = extractRelevantRecordData(records)
	console.log(summary)
}

export { scrape }
