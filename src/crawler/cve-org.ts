import type { CveRecord, SummarizedRecord } from "./cve-org.types.ts";
const fetchCveRecords = async () => {
	const CVE_ORG_API_URL = 'https://www.cve.org/restapiv1/search'
	const QUERY_STRING = "next.js"
	const DEFAULT_PAGE_SIZE = 25

	const body = {
		query: QUERY_STRING,
		from: 0,
		size: DEFAULT_PAGE_SIZE,
		sort: {
			property:"cveId",
			order:"desc"
		}
	}

	const options = {
		method: 'POST',
		body: JSON.stringify(body)
	}

	try {
		const response = await fetch(CVE_ORG_API_URL, options)
		if (!response.ok) {
			throw new Error(`Failed to fetch records with error: ${response.statusText}`)
		}
		const jsonData = await response.json()
		return jsonData.data
	} catch (error) {
		console.error(error)
	}
}

const extractRelevantRecordData = (records: Array<CveRecord>): Array<SummarizedRecord> => {
	return records.map(
		record => {
			return {
				cveId: record._source.cveMetadata.cveId,
				cvssV4: record._source.containers.cna.metrics[0].cvssV4_0.baseScore,
				title: record._source.containers.cna.title,
				state: record._source.cveMetadata.state,
				publishDate: record._source.cveMetadata.datePublished,
			}
		}
	)
}


const scrape = async () => {
	const records = await fetchCveRecords()
	const summary = extractRelevantRecordData(records)
	console.log(summary)
}

export { scrape }
