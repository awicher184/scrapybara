import type { CveRecord, SummarizedRecord } from "./cve-org.types.ts";

const DEFAULT_CONFIG = {
    apiUrl: 'https://www.cve.org/restapiv1/search',
    queryString: 'next.js',
    pageSize: 25,
}

const fetchCveRecords = async (): Promise<Array<CveRecord>>=> {

	const body = {
		query: DEFAULT_CONFIG.queryString,
		from: 0,
		size: DEFAULT_CONFIG.pageSize,
		sort: {
			property:"cveId",
			order:"desc"
		}
	}

	const options = {
		method: 'POST',
		body: JSON.stringify(body)
	}

	try {
		const response = await fetch(DEFAULT_CONFIG.apiUrl, options)
		if (!response.ok) {
			throw new Error(`cve.org API request failed with: ${response.status} - ${response.statusText}`)
		}
		const jsonData = await response.json() as { data: Array<CveRecord> }
		if (!jsonData || !Array.isArray(jsonData.data)) {
			throw new Error('cve.org API returned invalid data')
		}
		return jsonData.data
	} catch (error) {
		console.log(`cve.org data could not be fetched: ${error}`)
		throw error
	}
}

const summarizeRecords = (records: Array<CveRecord>): Array<SummarizedRecord> => {
	return records.map(
		record => {
			const metrics = record._source?.containers?.cna?.metrics
			const cvss = metrics.length > 0 ? metrics[0] : undefined
			return {
				cveId: record._source.cveMetadata.cveId,
				cvss: cvss?.cvssV4_0?.baseScore ?? cvss?.cvssV3_1?.baseScore ?? "N/A",
				title: record._source.containers.cna.title,
				state: record._source.cveMetadata.state,
				publishDate: record._source.cveMetadata.datePublished,
			}
		}
	)
}


const scrape = async () => {
	const records = await fetchCveRecords()
	return summarizeRecords(records)
}

export { scrape }
